[アドオン名]
Blender2Pmxe 1.0.6
(改変Blender2Pmx)

[動作環境]
Blender2.76b
(Win10 64bitで動作確認)


[本家Blender2Pmxとの違い]
■インポート
・英名を優先して読込み可能
・xmlファイルを連番で別名保存可能(1~32まで。番号が大きい方が新しいファイル)
・ボーン位置・角度を自動調整可能
	調整するのは「両目」、「腕捩り、手捩り」、「自動(補助)ボーン」、「足D、ひざD、足首D」
	捩りボーンはボーンの表示先で調整するので、モデルによっては軸がズレます。

・カスタムシェイプ付きでインポート可能
	シェイプを設定するのは「全ての親」、「両目」、「腕捩り、手捩り」、「自動(補助)ボーン」
	「両目」のシェイプ位置はズレやすいです。

■エクスポート
・(PMXファイル名).xmlが存在しない場合はアドオンフォルダ内のdefault.xmlを取り込む
・Armatureに連結されていないオブジェクトは出力しない
・マテリアルが存在しないオブジェクトは出力しない
・余計なマテリアルは出力しない(輪郭線機能のマテリアルも出力しない)
・カスタムノーマルを出力可能
・モディファイアを適用した状態で出力可能。ただし、シェイプキーが多いと出力に時間が掛かる
	Blenderで変形結果を正しく再現するならArmatureモディファイアの順番を最後の方にしてください。
	Edge SplitモディファイアのEdge Angleオプションは強制でオフになります。
	輪郭線機能のSolidifyモディファイアは適用しません。

■そのほか不具合修正など
・インポート時にBasisシェイプをアクティブに
・BDEF4のウェイト読込みの不具合修正
・テクスチャパスを間違えていてもインポート可能
・付与ボーンの付与率を-1~1に対応
・ボーン以外のウェイト(作業用ウェイト)を出力しない
・ウェイト値0を出力しない
・２番目のテクスチャスロットを'MULTIPLY'指定すると乗算スフィアとして出力するように変更。加算スフィアは従来どおり'ADD'
・xml使用時に余計な表示枠登録をしない
・xml指定の無い_L/_Rボーンの和名を左/右○○で出力
・xmlへの剛体・ジョイントの情報取得を小数点以下3桁から7桁へ変更
・xmlでのみ「変形階層」と「物理後」を指定可能に
・xmlにボーンのローカル軸を保存する仕組みを追加
・アクティブなUV MapsでPMX出力するように変更
・各モードのツールパネルに便利機能を追加


[インストール]
・ユーザー設定のAdd-onsで”Import-Export：MMD PMX Format (Extend)”を探してチェックを入れます
・▼を押してタブを開くとアドオンの設定を変更できます

[使用上の注意]
・カスタムノーマルを出力できるのはBlender2.74以降
・完全な変換ツールではありません。特にボーンの並び順は調整が必要
・SDEFの情報はサポートしません
・QDEFの情報はサポートしません
・エクスポート時に面UVから頂点UVへ変換するので、UVの縫い目で頂点数が増えます
・エクスポート時に面を三角に分割します
・他モデルのxmlを流用すると、ボーンのローカル軸がずれる可能性があります

・英名優先で使う場合は、PMXEで英名を変更しないでください
・和名優先で使う場合は、PMXEで和名を変更しないでください
	このルールを破るとXMLで正しい情報を引き継げなくなります。

[既知のバグ]
・IK制限角度のMMD(グローバル)とBlender(ローカル)の整合が未実装
・英名優先でインポートする場合、ボーンや材質の英名が重複してると挙動がおかしくなります
・カスタムシェイプを使った場合、Armatureを削除してもシェイプのオブジェクト(b2pmxe_shape_~)がデータ内に残る
	この改変アドオンでは大丈夫ですが、本家だとシェイプの頂点もエクスポートするので注意してください。
	「保存→開き直す」を2~3回繰り返せばデータから完全に消えます。

[更新履歴]
2016/04/03
Make XMLにボーンとウェイトを転送するオプションを追加。

2016/02/20
インポート時のエラーを修正。ポップアップ表示のオプションを間違えてた。

2016/01/24
エクスポート時のエラーをポップアップで分かりやすく。全体的に翻訳方法を変更。

2015/12/28
インポート時のウェイト読み込みの不具合を修正。
（重複したボーンのウェイトは足し算するようにした）

2015/12/16
Blender2.76bで(PMXファイル名).xmlを取得できない不具合を修正。
（bpy.path.ensure_extの処理が変わったのでos.path.splitextに変更）

2015/11/26
UVの切れ目の箇所にシェイプをつけてエクスポートすると、PMXでモーフが崩れる不具合を修整。（本家にこの不具合はありません）

2015/10/29
・Blender2Pmxのimporter 1.26 exporter 1.25をベースにして作成
・space_view3d_materials_utils.pyはmichaelwさんのソースコードを流用
・object_applymodifier.pyは@mato_sus304さんのソースコードを流用
・solidify_edge.pyは@che_tekuさんと@saidenkaさんのソースコードを流用
・アペンド処理は@che_tekuさんのソースコードを流用

［Tips等］
・PMX出力後のボーンの並び替えはPMX Editorのプラグインを使うのがいいと思います。
	モデルコピープラグイン入手先: http://kummd.com/

・シェイプキーが多いと出力時間が増えるので、左右に分割する必要があるモーフはPMX Editorのプラグインで作るのがいいと思います。
	簡易左右分割モーフ作成プラグイン入手先: https://bowlroll.net/file/7781

[サンプルについて]
sampleフォルダに入ってます。
・default.pmx
	default_en.xml, default_jp.xmlを生成するために使ったpmxファイル。
	モデルコピープラグインでボーンの並び替え用に使えるようにボーンを整頓してあります。

・sample.blend
	pmx出力テストのために作ったblendファイル。モディファイアを色々使っています。
	Mirror - ミラー。適用しないですむなら残した方がいいです。
	Mask - メッシュは残したいけど出力はしたくない時に使う。
	Edge Split - エッジを立てる時に使う。頂点は増えるが、質感がよくなる。
	Triangulate - 三角形分割の方法を変更する。何もしないよりはShortestかBeautyにした方がきれいになる。
	Solidify - 厚み付けだけでなく、布の裏地もこれで作れます。
	Data Transfer - これは色々な使い方ができますが、今回は法線をコピーするために使ってます。

・sample.xml
	sample.blend用のxmlファイル。表示枠・材質・剛体/Jointの情報が詰まってます。
	このファイルはpmx出力後にPMX Editorで表示枠・材質を調整、剛体/Jointを追加した後に、Make XML Fileで生成します。
	通常はテキストエディタで編集する必要は無いです。

・sample_finish.pmx
	sample.blendをpmx出力した後に、モデルコピープラグインでボーンを並び替えただけのファイルです。

実際にsample.blendを開いてから、
	1. Armatureをポーズモードへ変更。
	2. to A poseでAスタンスのポーズに変形する。
	3. Rebindでポーズボーンの変形を適用する。
	4. "sample.pmx"としてpmx出力。(Apply ModifiersとCustom Normalsはオンにする)
と試してみてください。sample_finish.pmxとほぼ同じモデルになっていれば出力成功です。


［最後に］
改変は自由にしてください。改良点は共有していただけると幸いです。
不具合はできるだけ修正しますが、私にはUVモーフ対応などの基本機能強化はできません。
